# =================== æ€§èƒ½æµ‹è¯•è„šæœ¬ ===================
import requests
import time
import statistics
import random

# ====== é…ç½®åŒºï¼ˆæ ¹æ®ä½ çš„ urls.py è°ƒæ•´ï¼‰======
BASE_URL = "http://127.0.0.1:8000"   # Django é»˜è®¤åœ°å€
QUESTION_ENDPOINT = "/"               # å¯¹åº” path('', views.search_post)
CLEAR_ENDPOINT = "/clear/"            # å¯¹åº” path('clear/', ...)
# =========================================

SESSION = requests.Session()

# æµ‹è¯•é—®é¢˜åˆ†ç±»
# KB_HIT_QUESTIONSï¼šçŸ¥è¯†åº“å¯ç­”é—®é¢˜ï¼ˆç»“æ„åŒ–å¼ºï¼Œå®ä½“æ˜ç¡®ï¼‰
KB_HIT_QUESTIONS = [
    # ç–¾ç—… â†’ ç—‡çŠ¶
    "èœ˜è››å’¬ä¼¤æœ‰ä»€ä¹ˆç—‡çŠ¶ï¼Ÿ",
    "èƒƒç‚æœ‰å“ªäº›ç—‡çŠ¶ï¼Ÿ",
    "æ„Ÿå†’çš„å…¸å‹ç—‡çŠ¶æ˜¯ä»€ä¹ˆï¼Ÿ",

    # ç–¾ç—… â†’ å¹¶å‘ç—‡
    "èœ˜è››å’¬ä¼¤æœ‰ä»€ä¹ˆå¹¶å‘ç—‡ï¼Ÿ",
    "ç³–å°¿ç—…å¯èƒ½å¼•å‘å“ªäº›å¹¶å‘ç—‡ï¼Ÿ",

    # ç–¾ç—… â†’ æ²»ç–—/ç”¨è¯
    "èƒƒç‚éœ€è¦ä»€ä¹ˆè¯æ²»ï¼Ÿ",
    "é«˜è¡€å‹åº”è¯¥ç”¨ä»€ä¹ˆè¯æ²»ç–—ï¼Ÿ",
    "é˜¿å¡æ³¢ç³–ç‰‡çš„ç–—æ•ˆæ˜¯ä»€ä¹ˆï¼Ÿ",

    # è¯å“ â†’ åŠŸæ•ˆ/ç”¨é€”
    "å¸ƒæ´›èŠ¬æœ‰ä»€ä¹ˆç”¨ï¼Ÿ",
    "é˜¿å¸åŒ¹æ—çš„ç–—æ•ˆæ˜¯ä»€ä¹ˆï¼Ÿ",

    # ç—‡çŠ¶ â†’ å¯èƒ½ç–¾ç—…ï¼ˆåå‘æ¨ç†ï¼‰
    "å–‰å’™ç—’å’³å—½å¯èƒ½æ˜¯å¾—äº†ä»€ä¹ˆç—…ï¼Ÿ",
    "è‚Œè‚‰ç–¼ç—›å¯èƒ½å¾—äº†ä»€ä¹ˆç—…ï¼Ÿ",

    # ç–¾ç—… â†’ é¢„é˜²æªæ–½
    "æ€ä¹ˆé¢„é˜²èœ˜è››å’¬ä¼¤ï¼Ÿ",
    "å¦‚ä½•é¢„é˜²èƒƒç‚ï¼Ÿ",

    # ç–¾ç—… â†’ æ¦‚è¿°
    "èœ˜è››å’¬ä¼¤çš„æ¦‚è¿°æ˜¯ä»€ä¹ˆï¼Ÿ",
    "ç³–å°¿ç—…çš„æ¦‚è¿°æ˜¯ä»€ä¹ˆï¼Ÿ"
]

# KB_MISS_QUESTIONSï¼šçŸ¥è¯†åº“æ— æ³•å›ç­”ï¼ˆè§¦å‘ LLM å…œåº•ï¼‰
KB_MISS_QUESTIONS = [
    # è¶…å‡ºé¢†åŸŸèŒƒå›´
    "å®‡å®™ä¸­æ˜¯å¦å­˜åœ¨å¤–æ˜Ÿç”Ÿå‘½ï¼Ÿ",
    "è¯·å†™ä¸€é¦–å…³äºå¥åº·çš„è¯—ã€‚",
    "AI ä¼šå–ä»£åŒ»ç”Ÿå—ï¼Ÿ",

    # å¤æ‚å¼€æ”¾æ€§é—®é¢˜
    "æœªæ¥åå¹´åŒ»å­¦ä¼šæœ‰å“ªäº›çªç ´ï¼Ÿ",
    "å¦‚ä½•æé«˜å…ç–«åŠ›ï¼Ÿ",

    # ä¸åœ¨æœ¬ä½“ä¸­çš„å®ä½“æˆ–å…³ç³»
    "æ–°å† ç–«è‹—çš„å‰¯ä½œç”¨æœ‰å“ªäº›ï¼Ÿ",  # è‹¥æœªå»ºæ¨¡ï¼Œåˆ™æ— æ³•å›ç­”
    "å¸•é‡‘æ£®ç—…çš„é—ä¼ æœºåˆ¶æ˜¯ä»€ä¹ˆï¼Ÿ",  # è¿‡äºå¤æ‚ï¼Œä¸åœ¨è§„åˆ™è¦†ç›–å†…

    # æ¨¡ç³Šæˆ–éæ ‡å‡†è¡¨è¾¾
    "æˆ‘æœ€è¿‘æ€»æ˜¯å¤´æ™•ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ",
    "ä¸ºä»€ä¹ˆæˆ‘ä¼šå¤±çœ ï¼Ÿ",
    "åƒè¾£ä¼šå½±å“è¡€å‹å—ï¼Ÿ"
]

def send_query(question: str) -> float:
    """å‘é€ä¸€æ¬¡æé—®è¯·æ±‚ï¼Œè¿”å›å“åº”æ—¶é—´ï¼ˆç§’ï¼‰"""
    start = time.time()
    try:
        response = SESSION.post(
            BASE_URL + QUESTION_ENDPOINT,
            data={"q": question.strip()},
            timeout=15  # ç»™ LLM è¶³å¤Ÿæ—¶é—´
        )
        end = time.time()
        if response.status_code == 200:
            return end - start
        else:
            print(f"âš ï¸ HTTP {response.status_code} for: {question[:30]}")
            return -1
    except Exception as e:
        print(f"âŒ è¯·æ±‚å¼‚å¸¸ ({question[:30]}): {e}")
        return -1

def run_test(questions, test_name, num_runs=10):
    """æ‰§è¡ŒæŒ‡å®šæ¬¡æ•°çš„æ€§èƒ½æµ‹è¯•"""
    print(f"\nğŸš€ å¼€å§‹ã€Œ{test_name}ã€æµ‹è¯•ï¼ˆ{num_runs} æ¬¡ï¼‰...")
    times = []
    for i in range(num_runs):
        q = random.choice(questions)
        t = send_query(q)
        if t > 0:
            times.append(t)
        time.sleep(0.3)  # é¿å…è¿‡å¿«ï¼ˆå¯è°ƒï¼‰

    if not times:
        print("  âŒ æ— æœ‰æ•ˆå“åº”è®°å½•")
        return None

    avg = statistics.mean(times)
    print(f"âœ… ã€Œ{test_name}ã€ç»“æœ:")
    print(f"    å¹³å‡å»¶è¿Ÿ: {avg:.3f} ç§’")
    print(f"    èŒƒå›´: [{min(times):.3f}, {max(times):.3f}] ç§’")
    print(f"    æˆåŠŸç‡: {len(times)}/{num_runs}")
    return avg

if __name__ == "__main__":
    print("=" * 50)
    print("åŒ»ç–—é—®ç­”ç³»ç»Ÿæ€§èƒ½æµ‹è¯•ï¼ˆé€‚é…ä½ çš„ urls.pyï¼‰")
    print("=" * 50)

    # å¯é€‰ï¼šå…ˆæ¸…ç©ºä¼šè¯å†å²
    try:
        SESSION.get(BASE_URL + CLEAR_ENDPOINT)
        print("ğŸ§¹ å·²æ¸…ç©ºä¼šè¯å†å²")
    except:
        print("âš ï¸ æ— æ³•è¿æ¥ /clear/ï¼Œè·³è¿‡æ¸…ç©º")

    # æ‰§è¡Œä¸¤ç±»æµ‹è¯•
    kb_avg = run_test(KB_HIT_QUESTIONS, "çŸ¥è¯†åº“å‘½ä¸­è·¯å¾„", 10)
    llm_avg = run_test(KB_MISS_QUESTIONS, "LLM å…œåº•è·¯å¾„", 10)

    # æ±‡æ€»
    print("\n" + "=" * 50)
    print("ğŸ“Š æ€§èƒ½æµ‹è¯•æ€»ç»“:")
    if kb_avg is not None:
        print(f"  [çŸ¥è¯†åº“] å¹³å‡å“åº”æ—¶é—´: {kb_avg:.3f} ç§’")
    if llm_avg is not None:
        print(f"  [LLMå…œåº•] å¹³å‡å“åº”æ—¶é—´: {llm_avg:.3f} ç§’")
    print("=" * 50)